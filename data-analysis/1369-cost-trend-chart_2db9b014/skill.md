# æ¯æ—¥æˆæœ¬è¶‹åŠ¿å›¾ (Stacked Area Chart)

## ç›®æ ‡

é€šè¿‡ MCP ç›´æ¥æŸ¥è¯¢ `my_shell_prod` æ•°æ®åº“ï¼Œç”ŸæˆæŒ‰ç”¨æˆ·ç±»å‹å †å çš„æ¯æ—¥æˆæœ¬è¶‹åŠ¿å›¾ã€‚

å¦‚æœåœ¨ base44 è¿è¡Œï¼Œåˆ™ @base44_prompt_mcphub.mdã€‚

## å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `start_date` | å¼€å§‹æ—¥æœŸ (YYYY-MM-DD) | 7å¤©å‰ |
| `end_date` | ç»“æŸæ—¥æœŸ (YYYY-MM-DD) | æ˜¨å¤© |

## æ•°æ®æº

- `my_shell_prod.art_task` - ä»»åŠ¡è¡¨ï¼ŒåŒ…å«æˆæœ¬æ•°æ®
- `my_shell_prod.user` - ç”¨æˆ·è¡¨ï¼ŒåŒ…å« source å­—æ®µ
- `my_shell_prod.user_privy` - ç”¨æˆ·é‚®ç®±ä¿¡æ¯

## ä¸´æ—¶é‚®ç®±åŸŸååˆ—è¡¨

ä»¥ä¸‹åŸŸåè¢«è®¤å®šä¸ºä¸´æ—¶é‚®ç®±ï¼ˆå…± 56 ä¸ªï¼‰ï¼š

```
protectsmail.net, roratu.com, mucate.com, mekuron.com, airsworld.net, 
arugy.com, forexzig.com, fxzig.com, denipl.com, denipl.net, nctime.com, 
fftube.com, correostemporales.org, yopmail.com, rosuper.com, ssgperf.com, 
m3player.com, guerrillamail.com, guerrillamail.org, guerrillamailblock.com, 
pokemail.net, spam4.me, grr.la, guerrillamail.biz, guerrillamail.de, 
trbvm.com, mailinator.com, 10minutemail.com, temp-mail.org, throwaway.email, 
getnada.com, maildrop.cc, trashmail.com, tempmailaddress.com, fakeinbox.com, 
mytemp.email, tempmail.com, emailondeck.com, sharklasers.com, discard.email, 
discardmail.com, mintemail.com, mailnesia.com, mohmal.com, crazymailing.com, 
mailcatch.com, mailnator.com, tempr.email, tempinbox.com, spamgourmet.com, 
mailexpire.com, dispostable.com, filzmail.com, getairmail.com, 
harakirimail.com, anonymbox.com
```

## ç™½åå•é‚®ç®±åŸŸååˆ—è¡¨

ä»¥ä¸‹åŸŸåè¢«è®¤å®šä¸ºç™½åå•é‚®ç®±ï¼ˆå…± 153 ä¸ªï¼Œæ¥æºï¼š[Notion ç™½åå•](https://www.notion.so/myshellai/2d43f81ff51e805cb05df7eef873f2f5)ï¼‰ï¼š

```
126.com, 139.com, 163.com, abv.bg, alice.it, aol.com, arcor.de, asia.com,
au.com, azet.sk, bk.ru, bluewin.ch, btinternet.com, centrum.cz, charter.net,
comcast.net, daum.net, docomo.ne.jp, earthlink.net, email.cz, email.it,
ezweb.ne.jp, fastmail.com, foxmail.com, free.fr, freenet.de, gmail.com,
gmx.at, gmx.ch, gmx.com, gmx.de, gmx.fr, gmx.net, googlemail.com, hanmail.net,
hey.com, hotmail.ca, hotmail.co.uk, hotmail.com, hotmail.de, hotmail.es,
hotmail.fr, hotmail.it, icloud.com, inbox.eu, inbox.lv, inbox.ru, interia.com,
interia.pl, internet.ru, iol.pt, laposte.net, libero.it, list.ru, live.ca,
live.com, live.de, live.fr, live.it, live.nl, live.se, mac.com, mail.com,
mail.ee, mail.ru, mailbox.org, me.com, msn.com, naver.com, netzero.net,
nifty.com, ntlworld.com, o2.pl, onet.pl, op.pl, orange.fr, outlook.co.id,
outlook.com, outlook.com.br, outlook.com.gr, outlook.cz, outlook.de,
outlook.es, outlook.hu, outlook.it, outlook.ph, petalmail.com, pm.me,
poczta.fm, post.com, posteo.de, prokonto.pl, proton.me, protonmail.com,
qq.com, rambler.ru, rediffmail.com, ro.ru, rocketmail.com, rogers.com,
runbox.com, sapo.pt, sbcglobal.net, seznam.cz, sfr.fr, sina.com, sky.com,
softbank.ne.jp, sohu.com, spoko.pl, t-online.de, telefonica.net, telus.net,
terra.com, tim.it, tin.it, tlen.pl, tuta.io, tutamail.com, tutanota.com,
ukr.net, verizon.net, virgilio.it, vk.com, vp.pl, wanadoo.fr, web.de, wp.pl,
ya.ru, yahoo.ca, yahoo.co.in, yahoo.co.jp, yahoo.com, yahoo.com.au, yahoo.de,
yahoo.es, yahoo.fr, yahoo.in, yahoo.it, yandex.ru, yeah.net, ymail.com,
zoho.com, zohomail.com, zoznam.sk
```

## ç”¨æˆ·åˆ†ç±»é€»è¾‘ï¼ˆäº’æ–¥åˆ†ç±»ï¼‰

**é‡è¦**ï¼šä»¥ä¸‹åˆ†ç±»æ˜¯äº’æ–¥çš„ï¼Œæ¯ä¸ªç”¨æˆ·çš„æ¯æ¬¡ä»»åŠ¡åªä¼šè¢«è®¡å…¥ä¸€ä¸ªåˆ†ç±»ï¼Œç¡®ä¿æˆæœ¬æ€»å’Œå‡†ç¡®ã€‚

| ç±»å‹ | æ¡ä»¶ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ä»˜è´¹ç”¨æˆ· | `user_membership_type != 'FREE'` | 1 |
| å…è´¹-Gmailåˆ«å âš ï¸ | `user_membership_type = 'FREE'` + Gmail/Googlemail é‚®ç®± + åŒ…å« `+` ç¬¦å·ï¼ˆåŒ…æ‹¬æ´»è·ƒç”¨æˆ·å’Œå·²åˆ é™¤ç”¨æˆ·ï¼‰ | 2 |
| å…è´¹-ä¸´æ—¶é‚®ç®± | `user_membership_type = 'FREE'` + é‚®ç®±åŸŸååœ¨ä¸´æ—¶é‚®ç®±åˆ—è¡¨ä¸­ + **ä¸æ˜¯Gmailåˆ«å** | 3 |
| å…è´¹-å¸¸ç”¨é‚®ç®± | `user_membership_type = 'FREE'` + æœ‰é‚®ç®± + **ä¸æ˜¯ä¸´æ—¶é‚®ç®±** + **ä¸æ˜¯Gmailåˆ«å** | 4 |
| å…è´¹-å·²åˆ é™¤ | `user_membership_type = 'FREE'` + `user.source = 'privy'` + `user_privy` æ— è®°å½• + **ä¸æ˜¯Gmailåˆ«å** | 5 |
| å…è´¹-è®¿å®¢ | `user_membership_type = 'FREE'` + `user.source = 'visitor'` | 6 |

**åˆ†ç±»è¯´æ˜**ï¼š
- **Gmailåˆ«å** ä½œä¸ºç‹¬ç«‹åˆ†ç±»ä¼˜å…ˆè¯†åˆ«ï¼Œä¸ä¼šè¢«è®¡å…¥å…¶ä»–å…è´¹ç”¨æˆ·åˆ†ç±»
- åŒ…æ‹¬æ´»è·ƒç”¨æˆ·ï¼ˆä» `user_privy` æŸ¥è¯¢ï¼‰å’Œå·²åˆ é™¤ç”¨æˆ·ï¼ˆä» `delete_user_log` æŸ¥è¯¢ï¼‰
- å…¶ä»–å…è´¹åˆ†ç±»å‡éœ€æ’é™¤ Gmail åˆ«åç”¨æˆ·ï¼Œé¿å…é‡å¤è®¡æ•°

---

## Step 1: æŸ¥è¯¢æ•°æ®

ä½¿ç”¨ `mcp_mcphub_bytebase-execute_sql` æ‰§è¡Œä»¥ä¸‹ SQLï¼ˆæ›¿æ¢ `{start_date}` å’Œ `{end_date}`ï¼‰:

### æŸ¥è¯¢1: ä»˜è´¹ç”¨æˆ·æ¯æ—¥æˆæœ¬

```sql
SELECT
  DATE(created_date) as snapshot_date,
  SUM(actual_energy_cost) / 100 as paid_cost
FROM my_shell_prod.art_task
WHERE user_membership_type != 'FREE'
  AND status IN ('done', 'cancel')
  AND DATE(created_date) >= '{start_date}'
  AND DATE(created_date) <= '{end_date}'
GROUP BY DATE(created_date)
ORDER BY snapshot_date
```

### æŸ¥è¯¢2: å…è´¹ç”¨æˆ·æ¯æ—¥æˆæœ¬ (æŒ‰ç±»å‹åˆ†ç»„)

æ‹†åˆ†æˆ 5 ä¸ªç‹¬ç«‹æŸ¥è¯¢ï¼Œæ¯ä¸ªæŸ¥è¯¢èŒè´£å•ä¸€ï¼Œæ–¹ä¾¿ç†è§£å’Œè°ƒè¯•ï¼š

#### æŸ¥è¯¢2a: ä¸´æ—¶é‚®ç®±ç”¨æˆ·æˆæœ¬

```sql
-- ä¸´æ—¶é‚®ç®±ç”¨æˆ·ï¼šæœ‰é‚®ç®± + åŸŸååœ¨ä¸´æ—¶é‚®ç®±åˆ—è¡¨ä¸­
SELECT
  DATE(at.created_date) as snapshot_date,
  SUM(at.actual_energy_cost) / 100 as temp_email_cost
FROM my_shell_prod.art_task at
LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
WHERE at.user_membership_type = 'FREE'
  AND at.status IN ('done', 'cancel')
  AND DATE(at.created_date) >= '{start_date}'
  AND DATE(at.created_date) <= '{end_date}'
  -- æœ‰é‚®ç®±
  AND COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) IS NOT NULL
  -- é‚®ç®±åŸŸååœ¨ä¸´æ—¶é‚®ç®±åˆ—è¡¨ä¸­
  AND SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1)
      IN ('protectsmail.net', 'roratu.com', 'mucate.com', 'mekuron.com', 'airsworld.net',
          'arugy.com', 'forexzig.com', 'fxzig.com', 'denipl.com', 'denipl.net', 'nctime.com',
          'fftube.com', 'correostemporales.org', 'yopmail.com', 'rosuper.com', 'ssgperf.com',
          'm3player.com', 'guerrillamail.com', 'guerrillamail.org', 'guerrillamailblock.com',
          'pokemail.net', 'spam4.me', 'grr.la', 'guerrillamail.biz', 'guerrillamail.de',
          'trbvm.com', 'mailinator.com', '10minutemail.com', 'temp-mail.org', 'throwaway.email',
          'getnada.com', 'maildrop.cc', 'trashmail.com', 'tempmailaddress.com', 'fakeinbox.com',
          'mytemp.email', 'tempmail.com', 'emailondeck.com', 'sharklasers.com', 'discard.email',
          'discardmail.com', 'mintemail.com', 'mailnesia.com', 'mohmal.com', 'crazymailing.com',
          'mailcatch.com', 'mailnator.com', 'tempr.email', 'tempinbox.com', 'spamgourmet.com',
          'mailexpire.com', 'dispostable.com', 'filzmail.com', 'getairmail.com',
          'harakirimail.com', 'anonymbox.com')
GROUP BY DATE(at.created_date)
ORDER BY snapshot_date
```

#### æŸ¥è¯¢2b: Gmail åˆ«åç”¨æˆ·æˆæœ¬

```sql
-- Gmail åˆ«åç”¨æˆ·ï¼šGmail/Googlemail åŸŸå + åŒ…å« '+' ç¬¦å·ï¼ˆåŒ…å«å·²åˆ é™¤ç”¨æˆ·ï¼‰
WITH free_users_with_email AS (
  SELECT
    at.user_id,
    DATE(at.created_date) as task_date,
    at.actual_energy_cost / 100 as cost_usd,
    COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) as active_email,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.email')) as deleted_email,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.google_email')) as deleted_google_email,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.apple_email')) as deleted_apple_email,
    CASE WHEN dul.user_id IS NOT NULL THEN 1 ELSE 0 END as is_deleted
  FROM my_shell_prod.art_task at
  LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
  LEFT JOIN my_shell_prod.delete_user_log dul ON at.user_id = dul.user_id AND dul.source = 'user_privy'
  WHERE at.user_membership_type = 'FREE'
    AND at.status IN ('done', 'cancel')
    AND DATE(at.created_date) >= '{start_date}'
    AND DATE(at.created_date) <= '{end_date}'
)
SELECT
  task_date as snapshot_date,
  SUM(cost_usd) as gmail_alias_cost
FROM free_users_with_email
WHERE (
  -- å·²åˆ é™¤ç”¨æˆ·çš„ Gmail åˆ«å
  (is_deleted = 1
   AND SUBSTRING_INDEX(COALESCE(NULLIF(deleted_email, ''), NULLIF(deleted_google_email, ''), NULLIF(deleted_apple_email, '')), '@', -1) IN ('gmail.com', 'googlemail.com')
   AND COALESCE(NULLIF(deleted_email, ''), NULLIF(deleted_google_email, ''), NULLIF(deleted_apple_email, '')) LIKE '%+%@%')
  OR
  -- æ´»è·ƒç”¨æˆ·çš„ Gmail åˆ«å
  (is_deleted = 0
   AND SUBSTRING_INDEX(active_email, '@', -1) IN ('gmail.com', 'googlemail.com')
   AND active_email LIKE '%+%@%')
)
GROUP BY task_date
ORDER BY snapshot_date
```

#### æŸ¥è¯¢2c: ç™½åå•é‚®ç®±ç”¨æˆ·æˆæœ¬

```sql
-- ç™½åå•é‚®ç®±ç”¨æˆ·ï¼šæœ‰é‚®ç®± + åŸŸååœ¨ç™½åå•ä¸­ + æ’é™¤ Gmail åˆ«å
SELECT
  DATE(at.created_date) as snapshot_date,
  SUM(at.actual_energy_cost) / 100 as whitelist_email_cost
FROM my_shell_prod.art_task at
LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
WHERE at.user_membership_type = 'FREE'
  AND at.status IN ('done', 'cancel')
  AND DATE(at.created_date) >= '{start_date}'
  AND DATE(at.created_date) <= '{end_date}'
  -- æœ‰é‚®ç®±
  AND COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) IS NOT NULL
  -- é‚®ç®±åŸŸååœ¨ç™½åå•ä¸­
  AND SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1)
      IN ('126.com', '139.com', '163.com', 'abv.bg', 'alice.it', 'aol.com', 'arcor.de', 'asia.com',
          'au.com', 'azet.sk', 'bk.ru', 'bluewin.ch', 'btinternet.com', 'centrum.cz', 'charter.net',
          'comcast.net', 'daum.net', 'docomo.ne.jp', 'earthlink.net', 'email.cz', 'email.it',
          'ezweb.ne.jp', 'fastmail.com', 'foxmail.com', 'free.fr', 'freenet.de', 'gmail.com',
          'gmx.at', 'gmx.ch', 'gmx.com', 'gmx.de', 'gmx.fr', 'gmx.net', 'googlemail.com', 'hanmail.net',
          'hey.com', 'hotmail.ca', 'hotmail.co.uk', 'hotmail.com', 'hotmail.de', 'hotmail.es',
          'hotmail.fr', 'hotmail.it', 'icloud.com', 'inbox.eu', 'inbox.lv', 'inbox.ru', 'interia.com',
          'interia.pl', 'internet.ru', 'iol.pt', 'laposte.net', 'libero.it', 'list.ru', 'live.ca',
          'live.com', 'live.de', 'live.fr', 'live.it', 'live.nl', 'live.se', 'mac.com', 'mail.com',
          'mail.ee', 'mail.ru', 'mailbox.org', 'me.com', 'msn.com', 'naver.com', 'netzero.net',
          'nifty.com', 'ntlworld.com', 'o2.pl', 'onet.pl', 'op.pl', 'orange.fr', 'outlook.co.id',
          'outlook.com', 'outlook.com.br', 'outlook.com.gr', 'outlook.cz', 'outlook.de',
          'outlook.es', 'outlook.hu', 'outlook.it', 'outlook.ph', 'petalmail.com', 'pm.me',
          'poczta.fm', 'post.com', 'posteo.de', 'prokonto.pl', 'proton.me', 'protonmail.com',
          'qq.com', 'rambler.ru', 'rediffmail.com', 'ro.ru', 'rocketmail.com', 'rogers.com',
          'runbox.com', 'sapo.pt', 'sbcglobal.net', 'seznam.cz', 'sfr.fr', 'sina.com', 'sky.com',
          'softbank.ne.jp', 'sohu.com', 'spoko.pl', 't-online.de', 'telefonica.net', 'telus.net',
          'terra.com', 'tim.it', 'tin.it', 'tlen.pl', 'tuta.io', 'tutamail.com', 'tutanota.com',
          'ukr.net', 'verizon.net', 'virgilio.it', 'vk.com', 'vp.pl', 'wanadoo.fr', 'web.de', 'wp.pl',
          'ya.ru', 'yahoo.ca', 'yahoo.co.in', 'yahoo.co.jp', 'yahoo.com', 'yahoo.com.au', 'yahoo.de',
          'yahoo.es', 'yahoo.fr', 'yahoo.in', 'yahoo.it', 'yandex.ru', 'yeah.net', 'ymail.com',
          'zoho.com', 'zohomail.com', 'zoznam.sk')
  -- æ’é™¤ Gmail åˆ«åç”¨æˆ·ï¼ˆäº’æ–¥åˆ†ç±»ï¼‰
  AND NOT (
    SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1) IN ('gmail.com', 'googlemail.com')
    AND COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) LIKE '%+%@%'
  )
GROUP BY DATE(at.created_date)
ORDER BY snapshot_date
```

#### æŸ¥è¯¢2d: å…¶ä»–é‚®ç®±ç”¨æˆ·æˆæœ¬

```sql
-- å…¶ä»–é‚®ç®±ç”¨æˆ·ï¼šæœ‰é‚®ç®± + åŸŸåä¸åœ¨ä¸´æ—¶é‚®ç®±åˆ—è¡¨ä¸­ + ä¸åœ¨ç™½åå•ä¸­ + æ’é™¤ Gmail åˆ«å
SELECT
  DATE(at.created_date) as snapshot_date,
  SUM(at.actual_energy_cost) / 100 as other_email_cost
FROM my_shell_prod.art_task at
LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
WHERE at.user_membership_type = 'FREE'
  AND at.status IN ('done', 'cancel')
  AND DATE(at.created_date) >= '{start_date}'
  AND DATE(at.created_date) <= '{end_date}'
  -- æœ‰é‚®ç®±
  AND COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) IS NOT NULL
  -- é‚®ç®±åŸŸåä¸åœ¨ä¸´æ—¶é‚®ç®±åˆ—è¡¨ä¸­
  AND SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1)
      NOT IN ('protectsmail.net', 'roratu.com', 'mucate.com', 'mekuron.com', 'airsworld.net',
              'arugy.com', 'forexzig.com', 'fxzig.com', 'denipl.com', 'denipl.net', 'nctime.com',
              'fftube.com', 'correostemporales.org', 'yopmail.com', 'rosuper.com', 'ssgperf.com',
              'm3player.com', 'guerrillamail.com', 'guerrillamail.org', 'guerrillamailblock.com',
              'pokemail.net', 'spam4.me', 'grr.la', 'guerrillamail.biz', 'guerrillamail.de',
              'trbvm.com', 'mailinator.com', '10minutemail.com', 'temp-mail.org', 'throwaway.email',
              'getnada.com', 'maildrop.cc', 'trashmail.com', 'tempmailaddress.com', 'fakeinbox.com',
              'mytemp.email', 'tempmail.com', 'emailondeck.com', 'sharklasers.com', 'discard.email',
              'discardmail.com', 'mintemail.com', 'mailnesia.com', 'mohmal.com', 'crazymailing.com',
              'mailcatch.com', 'mailnator.com', 'tempr.email', 'tempinbox.com', 'spamgourmet.com',
              'mailexpire.com', 'dispostable.com', 'filzmail.com', 'getairmail.com',
              'harakirimail.com', 'anonymbox.com')
  -- é‚®ç®±åŸŸåä¸åœ¨ç™½åå•ä¸­
  AND SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1)
      NOT IN ('126.com', '139.com', '163.com', 'abv.bg', 'alice.it', 'aol.com', 'arcor.de', 'asia.com',
              'au.com', 'azet.sk', 'bk.ru', 'bluewin.ch', 'btinternet.com', 'centrum.cz', 'charter.net',
              'comcast.net', 'daum.net', 'docomo.ne.jp', 'earthlink.net', 'email.cz', 'email.it',
              'ezweb.ne.jp', 'fastmail.com', 'foxmail.com', 'free.fr', 'freenet.de', 'gmail.com',
              'gmx.at', 'gmx.ch', 'gmx.com', 'gmx.de', 'gmx.fr', 'gmx.net', 'googlemail.com', 'hanmail.net',
              'hey.com', 'hotmail.ca', 'hotmail.co.uk', 'hotmail.com', 'hotmail.de', 'hotmail.es',
              'hotmail.fr', 'hotmail.it', 'icloud.com', 'inbox.eu', 'inbox.lv', 'inbox.ru', 'interia.com',
              'interia.pl', 'internet.ru', 'iol.pt', 'laposte.net', 'libero.it', 'list.ru', 'live.ca',
              'live.com', 'live.de', 'live.fr', 'live.it', 'live.nl', 'live.se', 'mac.com', 'mail.com',
              'mail.ee', 'mail.ru', 'mailbox.org', 'me.com', 'msn.com', 'naver.com', 'netzero.net',
              'nifty.com', 'ntlworld.com', 'o2.pl', 'onet.pl', 'op.pl', 'orange.fr', 'outlook.co.id',
              'outlook.com', 'outlook.com.br', 'outlook.com.gr', 'outlook.cz', 'outlook.de',
              'outlook.es', 'outlook.hu', 'outlook.it', 'outlook.ph', 'petalmail.com', 'pm.me',
              'poczta.fm', 'post.com', 'posteo.de', 'prokonto.pl', 'proton.me', 'protonmail.com',
              'qq.com', 'rambler.ru', 'rediffmail.com', 'ro.ru', 'rocketmail.com', 'rogers.com',
              'runbox.com', 'sapo.pt', 'sbcglobal.net', 'seznam.cz', 'sfr.fr', 'sina.com', 'sky.com',
              'softbank.ne.jp', 'sohu.com', 'spoko.pl', 't-online.de', 'telefonica.net', 'telus.net',
              'terra.com', 'tim.it', 'tin.it', 'tlen.pl', 'tuta.io', 'tutamail.com', 'tutanota.com',
              'ukr.net', 'verizon.net', 'virgilio.it', 'vk.com', 'vp.pl', 'wanadoo.fr', 'web.de', 'wp.pl',
              'ya.ru', 'yahoo.ca', 'yahoo.co.in', 'yahoo.co.jp', 'yahoo.com', 'yahoo.com.au', 'yahoo.de',
              'yahoo.es', 'yahoo.fr', 'yahoo.in', 'yahoo.it', 'yandex.ru', 'yeah.net', 'ymail.com',
              'zoho.com', 'zohomail.com', 'zoznam.sk')
  -- æ’é™¤ Gmail åˆ«åç”¨æˆ·ï¼ˆäº’æ–¥åˆ†ç±»ï¼‰
  AND NOT (
    SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')), '@', -1) IN ('gmail.com', 'googlemail.com')
    AND COALESCE(NULLIF(up.email, ''), NULLIF(up.google_email, ''), NULLIF(up.apple_email, '')) LIKE '%+%@%'
  )
GROUP BY DATE(at.created_date)
ORDER BY snapshot_date
```

#### æŸ¥è¯¢2e: å·²åˆ é™¤ç”¨æˆ·æˆæœ¬

```sql
-- å·²åˆ é™¤ç”¨æˆ·ï¼šuser.source = 'privy' ä½† user_privy è¡¨æ— è®°å½• + æ’é™¤ Gmail åˆ«å
WITH deleted_users AS (
  SELECT
    at.user_id,
    DATE(at.created_date) as task_date,
    at.actual_energy_cost / 100 as cost_usd,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.email')) as deleted_email,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.google_email')) as deleted_google_email,
    JSON_UNQUOTE(JSON_EXTRACT(dul.info, '$.apple_email')) as deleted_apple_email
  FROM my_shell_prod.art_task at
  LEFT JOIN my_shell_prod.user u ON at.user_id = u.id
  LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
  LEFT JOIN my_shell_prod.delete_user_log dul ON at.user_id = dul.user_id AND dul.source = 'user_privy'
  WHERE at.user_membership_type = 'FREE'
    AND at.status IN ('done', 'cancel')
    AND DATE(at.created_date) >= '{start_date}'
    AND DATE(at.created_date) <= '{end_date}'
    AND u.source = 'privy'
    AND up.user_id IS NULL
)
SELECT
  task_date as snapshot_date,
  SUM(cost_usd) as deleted_user_cost
FROM deleted_users
WHERE NOT (
  -- æ’é™¤ Gmail åˆ«åç”¨æˆ·ï¼ˆäº’æ–¥åˆ†ç±»ï¼‰
  SUBSTRING_INDEX(COALESCE(NULLIF(deleted_email, ''), NULLIF(deleted_google_email, ''), NULLIF(deleted_apple_email, '')), '@', -1) IN ('gmail.com', 'googlemail.com')
  AND COALESCE(NULLIF(deleted_email, ''), NULLIF(deleted_google_email, ''), NULLIF(deleted_apple_email, '')) LIKE '%+%@%'
)
GROUP BY task_date
ORDER BY snapshot_date
```

#### æŸ¥è¯¢2f: è®¿å®¢ç”¨æˆ·æˆæœ¬

```sql
-- è®¿å®¢ç”¨æˆ·ï¼šuser.source = 'visitor'
SELECT
  DATE(at.created_date) as snapshot_date,
  SUM(at.actual_energy_cost) / 100 as visitor_cost
FROM my_shell_prod.art_task at
LEFT JOIN my_shell_prod.user u ON at.user_id = u.id
WHERE at.user_membership_type = 'FREE'
  AND at.status IN ('done', 'cancel')
  AND DATE(at.created_date) >= '{start_date}'
  AND DATE(at.created_date) <= '{end_date}'
  -- ç”¨æˆ·æ¥æºæ˜¯è®¿å®¢
  AND u.source = 'visitor'
GROUP BY DATE(at.created_date)
ORDER BY snapshot_date
```

---

## Step 2: åˆå¹¶æ•°æ®

å°†æŸ¥è¯¢ç»“æœæŒ‰ `snapshot_date` åˆå¹¶ï¼Œå¾—åˆ°æ¯æ—¥çš„å®Œæ•´æ•°æ®ï¼š

```
snapshot_date | paid_cost | temp_email_cost | gmail_alias_cost | whitelist_email_cost | other_email_cost | deleted_user_cost | visitor_cost
```

---

## Step 3: ç”Ÿæˆå›¾è¡¨

ä½¿ç”¨ `mcp_mcphub_mcp-server-chart-generate_area_chart` ç”Ÿæˆå †å é¢ç§¯å›¾ï¼š

```json
{
  "title": "æ¯æ—¥æˆæœ¬è¶‹åŠ¿ï¼ˆæŒ‰ç”¨æˆ·ç±»å‹å †å ï¼‰",
  "axisXTitle": "æ—¥æœŸ",
  "axisYTitle": "æˆæœ¬ ($)",
  "stack": true,
  "data": [
    { "time": "12-19", "value": 95.5, "group": "ä»˜è´¹ç”¨æˆ·" },
    { "time": "12-19", "value": 105.2, "group": "å…è´¹-ä¸´æ—¶é‚®ç®±" },
    { "time": "12-19", "value": 32.5, "group": "å…è´¹-Gmailåˆ«å" },
    { "time": "12-19", "value": 380.3, "group": "å…è´¹-ç™½åå•é‚®ç®±" },
    { "time": "12-19", "value": 70.0, "group": "å…è´¹-å…¶ä»–é‚®ç®±" },
    { "time": "12-19", "value": 180.1, "group": "å…è´¹-å·²åˆ é™¤" },
    { "time": "12-19", "value": 45.6, "group": "å…è´¹-è®¿å®¢" },
    { "time": "12-20", "value": 120.8, "group": "ä»˜è´¹ç”¨æˆ·" },
    ...
  ],
  "style": {
    "palette": ["#3B82F6", "#06B6D4", "#EAB308", "#F97316", "#10B981", "#D946EF", "#8B5CF6"]
  }
}
```

### æ•°æ®è½¬æ¢è§„åˆ™

å°† SQL ç»“æœè½¬æ¢ä¸º chart data æ ¼å¼ï¼š

```javascript
// ä¼ªä»£ç 
const chartData = [];
for (const row of mergedData) {
  const date = row.snapshot_date.slice(5); // "2025-12-19" â†’ "12-19"
  chartData.push({ time: date, value: row.paid_cost, group: "ä»˜è´¹ç”¨æˆ·" });
  chartData.push({ time: date, value: row.temp_email_cost, group: "å…è´¹-ä¸´æ—¶é‚®ç®±" });
  chartData.push({ time: date, value: row.gmail_alias_cost, group: "å…è´¹-Gmailåˆ«å" });
  chartData.push({ time: date, value: row.whitelist_email_cost, group: "å…è´¹-ç™½åå•é‚®ç®±" });
  chartData.push({ time: date, value: row.other_email_cost, group: "å…è´¹-å…¶ä»–é‚®ç®±" });
  chartData.push({ time: date, value: row.deleted_user_cost, group: "å…è´¹-å·²åˆ é™¤" });
  chartData.push({ time: date, value: row.visitor_cost, group: "å…è´¹-è®¿å®¢" });
}
```

---

## é¢œè‰²é…ç½®

| group | é¢œè‰² |
|-------|------|
| ä»˜è´¹ç”¨æˆ· | `#3B82F6` (è“è‰²) |
| å…è´¹-ä¸´æ—¶é‚®ç®± | `#06B6D4` (é’è‰²) |
| å…è´¹-Gmailåˆ«å | `#EAB308` (é»„è‰²) âš ï¸ |
| å…è´¹-ç™½åå•é‚®ç®± | `#F97316` (æ©™è‰²) |
| å…è´¹-å…¶ä»–é‚®ç®± | `#10B981` (ç»¿è‰²) |
| å…è´¹-å·²åˆ é™¤ | `#D946EF` (ç²‰è‰²) |
| å…è´¹-è®¿å®¢ | `#8B5CF6` (ç´«è‰²) |

---

## æ ¸å¿ƒæŒ‡æ ‡

- **å…è´¹æˆæœ¬å æ¯”** = å…è´¹æ€»æˆæœ¬ / æ€»æˆæœ¬ Ã— 100%
- ç›®æ ‡: å…è´¹æˆæœ¬å æ¯”è¶‹åŠ¿å‘ä¸‹ ğŸ“‰
